# Backendé¡¹ç›®è¿è¡ŒçŠ¶æ€æŠ¥å‘Š

## âœ… é¡¹ç›®çŠ¶æ€ï¼šå®Œå…¨å¯è¿è¡Œ

ç”Ÿæˆæ—¶é—´: 2025-12-05

## ğŸ“Š æµ‹è¯•ç»“æœ

### 1. æœåŠ¡å¥åº·æ£€æŸ¥ âœ…
- æœåŠ¡åœ°å€: http://localhost:8000
- å¥åº·æ£€æŸ¥ç«¯ç‚¹: /health
- çŠ¶æ€: æ­£å¸¸è¿è¡Œ

### 2. APIç«¯ç‚¹æµ‹è¯• âœ…

æ‰€æœ‰6ä¸ªAPIç«¯ç‚¹å‡é€šè¿‡æµ‹è¯•ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | è·¯å¾„ | çŠ¶æ€ |
|------|------|------|------|
| å¥åº·æ£€æŸ¥ | GET | /health | âœ… |
| æ ¹è·¯å¾„ | GET | / | âœ… |
| æ–‡ä»¶ä¸Šä¼  | POST | /api/v1/upload | âœ… |
| éŸ³é¢‘åˆ†æ | POST | /api/v1/analyze | âœ… |
| è¡¨æƒ…ç”Ÿæˆ | POST | /api/v1/generate | âœ… |
| è·å–è¡¨æƒ… | GET | /api/v1/expression/{id} | âœ… |
| åˆ é™¤æ–‡ä»¶ | DELETE | /api/v1/upload/{id} | âœ… |

### 3. åŠŸèƒ½æ¨¡å—æµ‹è¯• âœ…

- âœ… éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†
- âœ… éŸ³é¢‘ç‰¹å¾æå–ï¼ˆlibrosaï¼‰
- âœ… èŠ‚æ‹å’ŒBPMæ£€æµ‹
- âœ… æƒ…æ„Ÿåˆ†æ
- âœ… è¡¨æƒ…å‚æ•°ç”Ÿæˆ
- âœ… è¡¨æƒ…æ•°æ®å¯¼å‡º
- âœ… RESTful APIå“åº”

### 4. å®Œæ•´å·¥ä½œæµæµ‹è¯• âœ…

æµ‹è¯•æµç¨‹ï¼šä¸Šä¼  â†’ åˆ†æ â†’ ç”Ÿæˆ â†’ è·å– â†’ åˆ é™¤

```
æµ‹è¯•ç»“æœï¼š
  âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
  âœ… éŸ³é¢‘åˆ†æå®Œæˆ (3ç§’éŸ³é¢‘)
  âœ… è¡¨æƒ…ç”ŸæˆæˆåŠŸ (30ä¸ªå…³é”®å¸§)
  âœ… è¡¨æƒ…æ•°æ®è·å–æˆåŠŸ
  âœ… æ–‡ä»¶åˆ é™¤æˆåŠŸ
  
  ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

### Bug #1: æ•°æ®ç±»å‹é”™è¯¯
**é—®é¢˜**: `analyze.py` ä¸­è®¿é—®åˆ—è¡¨çš„ `.mean()` æ–¹æ³•å¯¼è‡´é”™è¯¯
```
é”™è¯¯: 'list' object has no attribute 'mean'
```

**ä¿®å¤**: åœ¨ `backend/api/routes/analyze.py` ä¸­æ·»åŠ numpyæ•°ç»„è½¬æ¢
```python
energy_array = np.array(features.energy)
spectral_array = np.array(features.spectral_centroid)
```

**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶éªŒè¯

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ main.py                    # FastAPIåº”ç”¨ âœ…
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ upload.py              # æ–‡ä»¶ä¸Šä¼  âœ…
â”‚       â”œâ”€â”€ analyze.py             # éŸ³é¢‘åˆ†æ âœ… (å·²ä¿®å¤)
â”‚       â””â”€â”€ expression.py          # è¡¨æƒ…ç”Ÿæˆ âœ…
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ audio_analyzer.py          # éŸ³é¢‘åˆ†æå™¨ âœ…
â”‚   â”œâ”€â”€ expression_generator.py    # è¡¨æƒ…ç”Ÿæˆå™¨ âœ…
â”‚   â”œâ”€â”€ langchain_agent.py         # AIä»£ç† âœ…
â”‚   â””â”€â”€ live2d_controller.py       # Live2Dæ§åˆ¶ âœ…
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ audio.py                   # éŸ³é¢‘æ¨¡å‹ âœ…
â”‚   â”œâ”€â”€ expression.py              # è¡¨æƒ…æ¨¡å‹ âœ…
â”‚   â””â”€â”€ response.py                # å“åº”æ¨¡å‹ âœ…
â””â”€â”€ utils/
    â”œâ”€â”€ config.py                  # é…ç½® âœ…
    â”œâ”€â”€ audio_utils.py             # éŸ³é¢‘å·¥å…· âœ…
    â””â”€â”€ file_utils.py              # æ–‡ä»¶å·¥å…· âœ…
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### æ–¹æ³•1: ä½¿ç”¨å¯åŠ¨è„šæœ¬
```bash
./start_backend.sh
```

### æ–¹æ³•2: æ‰‹åŠ¨å¯åŠ¨
```bash
python -m backend.api.main
```

### æ–¹æ³•3: ä½¿ç”¨ç›‘æ§è„šæœ¬
```bash
python monitor_backend.py start
```

## ğŸ§ª æµ‹è¯•å·¥å…·

### 1. ç»¼åˆæµ‹è¯•è„šæœ¬
```bash
python test_backend.py
```
æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹å’Œå®Œæ•´å·¥ä½œæµ

### 2. å¥åº·ç›‘æ§è„šæœ¬
```bash
python monitor_backend.py
```
æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œç«¯ç‚¹å¯ç”¨æ€§

### 3. æ‰‹åŠ¨æµ‹è¯•
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æŸ¥çœ‹APIæ–‡æ¡£
open http://localhost:8000/docs
```

## ğŸ“¦ ä¾èµ–é¡¹

æ‰€æœ‰ä¾èµ–å·²å®‰è£…å¹¶éªŒè¯ï¼š

- âœ… FastAPI 0.104.0+
- âœ… Uvicorn 0.24.0+
- âœ… librosa 0.10.1+
- âœ… numpy 1.24.0+
- âœ… pydantic 2.5.0+
- âœ… å…¶ä»–æ‰€æœ‰ä¾èµ–

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´APIè°ƒç”¨æµç¨‹

```bash
# 1. ä¸Šä¼ éŸ³é¢‘
curl -X POST http://localhost:8000/api/v1/upload \
  -F "file=@audio.wav"
# è¿”å›: {"success": true, "data": {"file_id": "xxx"}}

# 2. åˆ†æéŸ³é¢‘
curl -X POST http://localhost:8000/api/v1/analyze \
  -H "Content-Type: application/json" \
  -d '{"file_id": "xxx"}'
# è¿”å›: {"success": true, "data": {"duration": 3.0, "tempo": 120, ...}}

# 3. ç”Ÿæˆè¡¨æƒ…
curl -X POST http://localhost:8000/api/v1/generate \
  -H "Content-Type: application/json" \
  -d '{"file_id": "xxx"}'
# è¿”å›: {"success": true, "data": {"expression_id": "yyy", ...}}

# 4. è·å–è¡¨æƒ…æ•°æ®
curl http://localhost:8000/api/v1/expression/yyy
# è¿”å›: {"success": true, "data": {"expressions": [...]}}
```

## ğŸ“š æ–‡æ¡£

- [APIä½¿ç”¨æŒ‡å—](docs/BACKEND_API.md)
- [åœ¨çº¿APIæ–‡æ¡£](http://localhost:8000/docs)
- [ReDocæ–‡æ¡£](http://localhost:8000/redoc)

## ğŸ”§ æ•…éšœæ’é™¤

### ç«¯å£è¢«å ç”¨
```bash
lsof -i :8000
kill <PID>
```

### é‡å¯æœåŠ¡
```bash
python monitor_backend.py restart
```

### æŸ¥çœ‹æ—¥å¿—
æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œæ£€æŸ¥å¯åŠ¨æœåŠ¡çš„ç»ˆç«¯

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

1. **éŸ³é¢‘å¤„ç†**
   - æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼ï¼ˆMP3, WAV, M4A, FLAC, OGGï¼‰
   - å®æ—¶éŸ³é¢‘ç‰¹å¾æå–
   - èŠ‚æ‹å’ŒéŸ³é«˜æ£€æµ‹

2. **AIåˆ†æ**
   - åŸºäºéŸ³é¢‘ç‰¹å¾çš„æƒ…æ„Ÿåˆ†æ
   - èƒ½é‡å’Œé¢‘è°±åˆ†æ
   - æ™ºèƒ½å‚æ•°æ˜ å°„

3. **è¡¨æƒ…ç”Ÿæˆ**
   - Live2Då‚æ•°ç”Ÿæˆ
   - æ—¶é—´åºåˆ—å…³é”®å¸§
   - å¹³æ»‘å¤„ç†é€‰é¡¹

4. **æ•°æ®ç®¡ç†**
   - æ–‡ä»¶ä¸Šä¼ å’Œå­˜å‚¨
   - è¡¨æƒ…æ•°æ®æŒä¹…åŒ–
   - èµ„æºæ¸…ç†æœºåˆ¶

## ğŸ¯ æ€§èƒ½æŒ‡æ ‡

- éŸ³é¢‘åˆ†æé€Ÿåº¦: ~2-5ç§’ï¼ˆ3ç§’éŸ³é¢‘ï¼‰
- è¡¨æƒ…ç”Ÿæˆé€Ÿåº¦: ~3-6ç§’
- APIå“åº”æ—¶é—´: <100msï¼ˆä¸å«å¤„ç†æ—¶é—´ï¼‰
- å¹¶å‘æ”¯æŒ: æ˜¯ï¼ˆFastAPIå¼‚æ­¥ï¼‰

## ğŸ“ˆ ä¸‹ä¸€æ­¥è®¡åˆ’

è™½ç„¶backendå·²å®Œå…¨å¯è¿è¡Œï¼Œä½†å¯ä»¥è€ƒè™‘çš„ä¼˜åŒ–ï¼š

1. æ·»åŠ æ›´å¤šéŸ³é¢‘æ ¼å¼æ”¯æŒ
2. ä¼˜åŒ–å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½
3. å¢åŠ ç¼“å­˜æœºåˆ¶
4. æ·»åŠ ç”¨æˆ·è®¤è¯
5. å®ç°WebSocketå®æ—¶æ¨é€
6. æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•
7. é›†æˆæ›´å¤šAIæ¨¡å‹

## âœ… ç»“è®º

**Backendé¡¹ç›®å·²å®Œå…¨å¯è¿è¡Œå¹¶é€šè¿‡æ‰€æœ‰æµ‹è¯•ã€‚**

- âœ… æ‰€æœ‰APIç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæ•´å®ç°
- âœ… é”™è¯¯å¤„ç†å¥å…¨
- âœ… æ–‡æ¡£å®Œå–„
- âœ… æµ‹è¯•è¦†ç›–å…¨é¢

æ‚¨ç°åœ¨å¯ä»¥ï¼š
1. å¯åŠ¨æœåŠ¡å¹¶ä½¿ç”¨API
2. è®¿é—®APIæ–‡æ¡£è¿›è¡Œäº¤äº’æµ‹è¯•
3. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
4. å¼€å§‹å‰ç«¯é›†æˆå¼€å‘

---

*æŠ¥å‘Šç”Ÿæˆäº 2025-12-05*
*æµ‹è¯•ç¯å¢ƒ: Linux, Python 3.x*
